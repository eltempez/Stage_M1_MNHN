---
title: "Species distribution (normalised by genome length)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide', warning=FALSE, message=FALSE, out.width = "100%")
```


```{r}
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(scales)
library(dplyr)
library(paletteer)
library(ggthemes)

##### Setting up #####
# Functions
get_sample_name <- function(file_path) {
  species_name <- gsub(".*/([^/]+)_global_metrics\\.txt", "\\1", file_path)
  return(species_name)
}

# Read input files
glob_metrics_file <- commandArgs(trailingOnly=T)[1]
species_file <- commandArgs(trailingOnly=T)[2]

data <- read.table(glob_metrics_file, skip = 2, header = TRUE, sep = "\t")
nb_reads <- read.table(glob_metrics_file, nrows = 1, sep =  "\t")[, 2]
nb_reads_clean <- read.table(glob_metrics_file, nrows = 1, sep =  "\t", skip = 1)[, 2]
sample_name <- get_sample_name(glob_metrics_file)

species_info <- read.table(species_file, sep = "\t")
colnames(species_info) <- c("library", "ncbi", "species", "type")
```
# **sample : `r sample_name`**

$$\\[0.5in]$$

```{r}
##### Graphs #####
## Number of reads cleaned and aligned
# create dataframe
nb_low_qual <- nb_reads - nb_reads_clean
nb_aligned_reads <- sum(data$nb_mapped_reads)
data_1 <- data.frame("condition" = c("low_qual", "unaligned", "aligned"),
                     "nb" = c(nb_low_qual,
                              nb_reads_clean - nb_aligned_reads,
                              nb_aligned_reads))
# add percents
data_1 %>%
  arrange(desc(nb)) %>%
  mutate(prop = percent(nb / sum(nb), 0.1)) -> data_1 

# pie chart
ggplot(data_1, aes(x = "", y = nb, fill = fct_inorder(condition))) +
  geom_bar(width = 1, linewidth = 0.1, color = "white", stat = "identity") +
  geom_label_repel(aes(label = prop), 
                   segment.colour = rgb(0, 0, 0, 0),
                   size = 4, show.legend = FALSE, nudge_x = 0.5) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("Global read distribution") +
  coord_polar("y", start = 0) +
  scale_fill_manual(name = "Percents of reads",
                    values = c("low_qual" = "#737373", 
                               "unaligned" = "#873939", 
                               "aligned" = "#398772"),
                    labels = c("low_qual" = "low quality", 
                               "unaligned" = "unmapped", 
                               "aligned" = "mapped"))
```

$$\\[1in]$$

```{r}
## Species distribution
data_2 <- merge(species_info, 
                data[, c("library", "p_read_coverage_normalised", "nb_mapped_reads")], 
                by = "library")
data_2 %>%
  arrange(type, desc(p_read_coverage_normalised)) -> data_2

# Barplots
# set up colors
lacto_species <- data_2[which(data_2[, "type"] == "lacto"), "species"]
aceto_species <- data_2[which(data_2[, "type"] == "aceto"), "species"]
yeast_species <- data_2[which(data_2[, "type"] == "yeast"), "species"]
other_species <- data_2[which(data_2[, "type"] == "other"), "species"]
lacto_colors <- paletteer::paletteer_dynamic("cartography::red.pal", length(lacto_species), -1)
names(lacto_colors) <- lacto_species
aceto_colors <- paletteer::paletteer_dynamic("cartography::blue.pal", length(aceto_species), -1)
names(aceto_colors) <- aceto_species
yeast_colors <- paletteer::paletteer_dynamic("cartography::green.pal", length(yeast_species), -1)
names(yeast_colors) <- yeast_species
other_colors <- paletteer::paletteer_dynamic("cartography::purple.pal", length(other_species), -1)
names(other_colors) <- other_species

# plot
ggplot(data_2, aes(x = type, y = p_read_coverage_normalised, fill = fct_inorder(species))) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "%", 
       title = "Proportion of reads mapped on each species") +
  guides(fill = guide_legend(title = "species")) +
  scale_fill_manual(values = c(aceto_colors, lacto_colors, yeast_colors, other_colors)) +
  scale_x_discrete(labels = c("aceto" = "Acetobacteraceae", 
                              "lacto" = "Lactobacillales", 
                              "yeast" = "Yeasts",
                              "other" = "Other"))
```


```{r}
# grouped by type of micro-organism
ggplot(data_2, aes(x = type, y = p_read_coverage_normalised, fill = fct_inorder(species))) +
  geom_bar(stat = "identity") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "%", 
       title = "") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c(aceto_colors, lacto_colors, yeast_colors, other_colors)) +
  scale_x_discrete(labels = c("aceto" = "Acetobacteraceae", 
                              "lacto" = "Lactobacillales", 
                              "yeast" = "Yeasts",
                              "other" = "Other"))
```

$$\\[1in]$$

```{r}
# Dotplot with all 21 species
data_3 <- merge(species_info, 
                data[, c("library", "p_read_coverage_normalised", "genome_coverage")], 
                by = "library")
data_3 %>%
  arrange(desc(p_read_coverage_normalised)) -> data_3

ggplot(data_3, aes(x = "", y = fct_inorder(species), size = genome_coverage, color = type)) +
  geom_point(alpha = 0.85) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_colour_manual(labels = c("aceto" = "Acetobacteraceae",
                                 "lacto" = "Lactobacillales",
                                 "yeast" = "Yeasts",
                                 "other" = "Other"),
                      values = c("aceto" = "#115379FF",
                                 "lacto" = "#7C000CFF",
                                 "yeast" = "#186D2EFF",
                                 "other" = "#76388AFF")) +
  scale_size_area(labels = comma, name = "number of times the genome is covered") +
  labs(x = "", y = "species", 
       title = "Genome coverage")
```

