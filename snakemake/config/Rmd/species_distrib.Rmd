---
title: "species_distrib"
output: html_document
params:
   rmd: "species_distrib.Rmd"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide', warning=FALSE)
```


```{r}
library(argparse)
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(scales)
library(dplyr)
library(paletteer)


##### Setting up #####
# Functions
get_sample_name <- function(file_path) {
  species_name <- gsub(".*/([^/]+)_global_metrics\\.txt", "\\1", file_path)
  return(species_name)
}

# Read input files
glob_metrics_file <- snakemake@input[[1]]
species_file <- snakemake@input[[2]]

data <- read.table(glob_metrics_file, skip = 2, header = TRUE, sep = "\t")
nb_reads <- read.table(glob_metrics_file, nrows = 1, sep =  "\t")[, 2]
nb_reads_clean <- read.table(glob_metrics_file, nrows = 1, sep =  "\t", skip = 1)[, 2]
sample_name <- get_sample_name(glob_metrics_file)

species_info <- read.table(species_file, sep = "\t")
colnames(species_info) <- c("library", "ncbi", "species", "type")
```

```{r}
##### Graphs #####
## Number of reads cleaned and aligned
# create dataframe
nb_aligned_reads <- round(sum(data$Percents.read.coverage) / 100 * nb_reads_clean)
data_1 <- data.frame("condition" = c("low_qual", "unaligned", "aligned"),
                "nb" = c(nb_reads - nb_reads_clean,
                         nb_reads_clean - nb_aligned_reads,
                         nb_aligned_reads))
# add percents
data_1 %>%
  arrange(desc(nb)) %>%
  mutate(prop = percent(nb / sum(nb), 0.1)) -> data_1 

# pie chart
ggplot(data_1, aes(x = "", y = nb, fill = fct_inorder(condition))) +
  geom_bar(width = 1, linewidth = 0.1, color = "white", stat = "identity") +
  geom_label_repel(aes(label = prop), 
                   segment.colour = rgb(0, 0, 0, 0),
                   size = 4, show.legend = FALSE, nudge_x = 0.5) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle(paste0("Global read distribution\n", sample_name)) +
  coord_polar("y", start = 0) +
  scale_fill_manual(name = "Percents of reads",
                    values = c("low_qual" = "#5B5B5B", 
                               "unaligned" = "#8D6767", 
                               "aligned" = "#5C7C6C"),
                    labels = c("low_qual" = "low quality", 
                               "unaligned" = "unmapped", 
                               "aligned" = "mapped"))
```


```{r}
## Species distribution
data_2 <- merge(species_info, 
                data[, c("library", "Percents.read.coverage", "Number.reads")], 
                   by = "library")
data_2 %>%
  filter(Percents.read.coverage >= 0.1) %>%
  arrange(type, desc(Percents.read.coverage)) -> data_2



# Barplots
ggplot(data_2, aes(x = type, y = Percents.read.coverage, fill = fct_inorder(species))) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "%", 
       title = paste0("Proportion of reads mapped on each species (> 0.01 %)\n", sample_name)) +
  scale_fill_viridis_d(option = "D", name = "species") +
  scale_x_discrete(labels = c("aceto" = "Acetobacteraceae", 
                              "lacto" = "Lactobacillales", 
                              "yeast" = "Yeasts",
                              "other" = "Other"))
```


```{r}
ggplot(data_2, aes(x = type, y = Percents.read.coverage, fill = fct_inorder(species))) +
  geom_bar(stat = "identity") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "%", 
       title = paste0("Proportion of reads mapped on each species (> 0.01 %)\n", sample_name)) +
  scale_fill_viridis_d(option = "D") +
  guides(fill = FALSE) +
  scale_x_discrete(labels = c("aceto" = "Acetobacteraceae", 
                              "lacto" = "Lactobacillales", 
                              "yeast" = "Yeasts",
                              "other" = "Other"))
```


```{r}
# Dotplot
ggplot(data_2, aes(x = "", y = fct_inorder(species), size = Number.reads, color = type)) +
  geom_point() +
  theme(plot.title = element_text(hjust = 0.5)) +
  paletteer::scale_colour_paletteer_d("ochRe::lorikeet",
                                      labels = c("aceto" = "Acetobacteraceae", 
                                                 "lacto" = "Lactobacillales", 
                                                 "yeast" = "Yeasts",
                                                 "other" = "Other")) +
  scale_size_continuous(labels = comma, name = "number of reads") +
  labs(x = "", y = "species", 
       title = paste0("Proportion of reads mapped on each species (> 0.01 %)\n", sample_name))
```

